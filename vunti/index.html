<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vunti - Secure Messaging (Supabase v2)</title>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <style>
    /* --- your original CSS (kept mostly intact) --- */
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Helvetica,Arial,sans-serif}
    :root{
      --primary:#128C7E;--primary-dark:#075E54;--primary-light:#25D366;--secondary:#34B7F1;
      --light:#ECE5DD;--dark:#3C3C3C;--white:#FFFFFF;--gray:#8696A0;--light-gray:#F0F2F5;
      --dark-gray:#2A2F32;--message-received:#FFFFFF;--message-sent:#DCF8C6;--online:#00FF00;
      --offline:#A0A0A0;--notification:#F15C6D;--transition:all .3s ease;
    }
    body{background:linear-gradient(135deg,var(--primary),var(--primary-dark));height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden}
    body.dark-mode{background:linear-gradient(135deg,#0a3d2e,#062e23)}
    .container{width:100%;max-width:1400px;height:95vh;background:var(--light);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);overflow:hidden;display:flex;animation:fadeIn .8s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .sidebar{width:30%;background-color:var(--white);display:flex;flex-direction:column;border-right:1px solid rgba(0,0,0,.1);transition:var(--transition)}
    .dark-mode .sidebar{background-color:var(--dark-gray);border-color:rgba(255,255,255,.1)}
    .sidebar-header{padding:15px;background-color:var(--light-gray);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(0,0,0,.08)}
    .dark-mode .sidebar-header{background-color:#2d3134;border-color:rgba(255,255,255,.1)}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px;cursor:pointer}
    .user-name{font-weight:600;color:var(--dark)}
    .dark-mode .user-name{color:var(--white)}
    .header-actions{display:flex;gap:15px}
    .icon-btn{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;border:none;font-size:18px;color:var(--gray);transition:var(--transition)}
    .icon-btn:hover{background-color:rgba(0,0,0,.05)}
    .dark-mode .icon-btn:hover{background-color:rgba(255,255,255,.1)}
    .search-container{padding:10px 15px;background-color:var(--light-gray)}
    .dark-mode .search-container{background-color:#2d3134}
    .search-box{background-color:var(--white);border-radius:20px;padding:8px 15px;display:flex;align-items:center;gap:10px}
    .dark-mode .search-box{background-color:#3a3f42}
    .search-box input{flex:1;border:none;background:transparent;font-size:14px;outline:none}
    .dark-mode .search-box input{color:var(--light)}
    .chats-list{flex:1;overflow-y:auto}
    .chat-item{display:flex;align-items:center;padding:12px 15px;gap:15px;cursor:pointer;transition:var(--transition);border-bottom:1px solid rgba(0,0,0,.05)}
    .chat-item:hover,.chat-item.active{background-color:rgba(0,0,0,.03)}
    .dark-mode .chat-item:hover,.dark-mode .chat-item.active{background-color:rgba(255,255,255,.05)}
    .chat-avatar{position:relative}
    .chat-avatar-img{width:55px;height:55px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:20px}
    .online-status{position:absolute;bottom:0;right:0;width:14px;height:14px;border-radius:50%;background-color:var(--online);border:2px solid var(--white)}
    .dark-mode .online-status{border-color:var(--dark-gray)}
    .chat-info{flex:1}
    .chat-info-top{display:flex;justify-content:space-between;margin-bottom:5px}
    .chat-name{font-weight:600;color:var(--dark)}
    .dark-mode .chat-name{color:var(--white)}
    .chat-time{font-size:12px;color:var(--gray)}
    .chat-preview{display:flex;align-items:center;gap:5px;font-size:14px;color:var(--gray)}
    .unread-badge{background-color:var(--primary);color:white;font-size:12px;font-weight:600;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .chat-window{flex:1;display:flex;flex-direction:column;background-color:var(--light);background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d1d7db' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E")}
    .dark-mode .chat-window{background-color:var(--dark-gray);background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233a3f42' fill-opacity='0.3' fill-rule='evenodd'/%3E%3C/svg%3E")}
    .chat-header{padding:15px;background-color:var(--light-gray);display:flex;align-items:center;gap:15px;border-bottom:1px solid rgba(0,0,0,.08)}
    .dark-mode .chat-header{background-color:#2d3134;border-color:rgba(255,255,255,.1)}
    .chat-header-info{flex:1}
    .chat-header-name{font-weight:600;color:var(--dark)}
    .dark-mode .chat-header-name{color:var(--white)}
    .chat-header-status{font-size:13px;color:var(--gray);display:flex;align-items:center;gap:5px}
    .dark-mode .chat-header-status{color:#a0a0a0}
    .status-indicator{width:8px;height:8px;border-radius:50%;background-color:var(--online)}
    .messages-container{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px}
    .message{max-width:70%;padding:12px 15px;border-radius:7.5px;position:relative;animation:fadeIn .3s;box-shadow:0 1px 1px rgba(0,0,0,.1);word-wrap:break-word}
    .message.received{align-self:flex-start;background-color:var(--message-received);border-bottom-left-radius:0}
    .dark-mode .message.received{background-color:#33383b;color:var(--light)}
    .message.sent{align-self:flex-end;background-color:var(--message-sent);border-bottom-right-radius:0}
    .message-time{font-size:11px;margin-top:5px;text-align:right;opacity:.7}
    .message.sent .message-time{color:rgba(0,0,0,.6)}
    .message.received .message-time{color:var(--gray)}
    .dark-mode .message.sent .message-time{color:rgba(255,255,255,.6)}
    .dark-mode .message.received .message-time{color:#a0a0a0}
    .chat-input-area{padding:15px;background-color:var(--light-gray);display:flex;align-items:center;gap:12px;border-top:1px solid rgba(0,0,0,.08)}
    .dark-mode .chat-input-area{background-color:#2d3134;border-color:rgba(255,255,255,.1)}
    .chat-input-actions{display:flex;gap:10px}
    .emoji-btn,.attachment-btn{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;border:none;font-size:20px;color:var(--gray);transition:var(--transition)}
    .emoji-btn:hover,.attachment-btn:hover{background-color:rgba(0,0,0,.05)}
    .dark-mode .emoji-btn:hover,.dark-mode .attachment-btn:hover{background-color:rgba(255,255,255,.1)}
    .chat-input-container{flex:1;background-color:var(--white);border-radius:20px;display:flex;align-items:center;padding:0 15px}
    .dark-mode .chat-input-container{background-color:#3a3f42}
    .chat-input{flex:1;border:none;padding:12px 0;font-size:16px;background:transparent;outline:none;resize:none;max-height:120px}
    .dark-mode .chat-input{color:var(--light)}
    .send-btn{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;background-color:var(--primary);border:none;font-size:18px;color:white;transition:var(--transition)}
    .send-btn:hover{background-color:var(--primary-dark)}
    .auth-container{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--primary),var(--primary-dark));display:flex;justify-content:center;align-items:center;z-index:100;transition:opacity .5s ease}
    .auth-container.hidden{opacity:0;pointer-events:none}
    .auth-box{background:var(--white);border-radius:15px;padding:40px;width:100%;max-width:450px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center}
    .dark-mode .auth-box{background:var(--dark-gray)}
    .app-logo{font-size:50px;color:var(--primary);margin-bottom:20px}
    .app-title{font-size:32px;font-weight:700;color:var(--white);margin-bottom:30px;background:linear-gradient(to right,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .auth-form{margin-bottom:25px}
    .form-group{margin-bottom:20px}
    .form-input{width:100%;padding:14px;border:1px solid #ddd;border-radius:8px;font-size:16px;transition:var(--transition)}
    .form-input:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(18,140,126,.2)}
    .dark-mode .form-input{background-color:#3a3f42;border-color:#555;color:var(--light)}
    .auth-btn{width:100%;padding:14px;border:none;border-radius:8px;background-color:var(--primary);color:white;font-size:16px;font-weight:600;cursor:pointer;transition:var(--transition)}
    .auth-btn:hover{background-color:var(--primary-dark)}
    .auth-divider{position:relative;margin:25px 0;color:var(--gray)}
    .auth-divider::before{content:"";position:absolute;left:0;top:50%;width:42%;height:1px;background-color:#ddd}
    .auth-divider::after{content:"";position:absolute;right:0;top:50%;width:42%;height:1px;background-color:#ddd}
    .dark-mode .auth-divider::before,.dark-mode .auth-divider::after{background-color:#555}
    .oauth-btns{display:flex;gap:15px;margin-bottom:20px}
    .oauth-btn{flex:1;padding:12px;border:1px solid #ddd;border-radius:8px;background-color:transparent;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;font-weight:500;transition:var(--transition)}
    .oauth-btn:hover{background-color:rgba(0,0,0,.05)}
    .dark-mode .oauth-btn{border-color:#555;color:var(--light)}
    .dark-mode .oauth-btn:hover{background-color:rgba(255,255,255,.1)}
    .auth-link{color:var(--primary);font-weight:500;cursor:pointer;margin-top:15px;display:inline-block}
    @media (max-width:992px){.sidebar{width:40%}}
    @media (max-width:768px){.container{height:100vh;border-radius:0}.sidebar{width:100%}.chat-window{display:none}.chat-window.active{display:flex;position:absolute;top:0;left:0;width:100%;height:100%}}
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-container" id="authContainer">
    <div class="auth-box">
      <div class="app-logo"><i class="fab fa-whatsapp"></i></div>
      <h1 class="app-title">Vunti Messenger</h1>

      <div class="auth-form" id="loginForm">
        <div class="form-group">
          <input type="email" class="form-input" id="emailInput" placeholder="Email address" />
        </div>
        <div class="form-group">
          <input type="password" class="form-input" id="passwordInput" placeholder="Password" />
        </div>
        <button class="auth-btn" id="loginBtn">Sign In</button>
      </div>

      <div class="auth-form hidden" id="signupForm">
        <div class="form-group">
          <input type="text" class="form-input" id="nameInput" placeholder="Full name" />
        </div>
        <div class="form-group">
          <input type="email" class="form-input" id="signupEmailInput" placeholder="Email address" />
        </div>
        <div class="form-group">
          <input type="password" class="form-input" id="signupPasswordInput" placeholder="Password" />
        </div>
        <button class="auth-btn" id="signupBtn">Create Account</button>
      </div>

      <div class="auth-divider">or</div>

      <div class="oauth-btns">
        <button class="oauth-btn" id="googleBtn"><i class="fab fa-google"></i> Google</button>
        <button class="oauth-btn" id="facebookBtn"><i class="fab fa-facebook"></i> Facebook</button>
      </div>

      <div class="auth-link" id="toggleFormLink">Create new account</div>
    </div>
  </div>

  <!-- Main App -->
  <div class="container" id="appContainer" style="display:flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">JS</div>
          <div class="user-name" id="userName">John Smith</div>
        </div>
        <div class="header-actions">
          <button class="icon-btn"><i class="fas fa-users"></i></button>
          <button class="icon-btn"><i class="fas fa-circle-notch"></i></button>
          <button class="icon-btn" id="darkModeToggle"><i class="fas fa-moon"></i></button>
        </div>
      </div>

      <!-- Search -->
      <div class="search-container">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search or start new chat" id="searchInput" />
        </div>
      </div>

      <!-- Chats List -->
      <div class="chats-list" id="chatsList">
        <!-- static demo list; you can wire this to a conversations table later -->
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-avatar">
          <div class="chat-avatar-img" id="chatAvatar">ES</div>
          <div class="online-status" id="chatOnlineStatus"></div>
        </div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chatHeaderName">Emma Stone</div>
          <div class="chat-header-status"><div class="status-indicator"></div><span id="chatStatusText">Online</span></div>
        </div>
        <div class="header-actions">
          <button class="icon-btn"><i class="fas fa-phone-alt"></i></button>
          <button class="icon-btn"><i class="fas fa-video"></i></button>
          <button class="icon-btn"><i class="fas fa-info-circle"></i></button>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-container" id="messagesContainer">
        <!-- messages injected here -->
      </div>

      <!-- Chat Input -->
      <div class="chat-input-area">
        <div class="chat-input-actions">
          <button class="emoji-btn"><i class="far fa-smile"></i></button>
          <button class="attachment-btn"><i class="fas fa-paperclip"></i></button>
        </div>
        <div class="chat-input-container">
          <textarea class="chat-input" placeholder="Type a message..." id="messageInput"></textarea>
        </div>
        <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    /******************************************************************
     * Replace these with your supplied project values (done already)
     ******************************************************************/
    const SUPABASE_URL = 'https://fflawatbcocazbsblzkl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmbGF3YXRiY29jYXpic2JsemtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1OTQzMDcsImV4cCI6MjA3MDE3MDMwN30.4bCY4AcHHsWsXJCvcVhoVXABdn7UV3S7pxIuX4jMoww';

    // Initialize Supabase client
    const supabase = supabaseJs.createClient
      ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- DOM references ---
    const authContainer = document.getElementById('authContainer');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const toggleFormLink = document.getElementById('toggleFormLink');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesContainer = document.getElementById('messagesContainer');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const nameInput = document.getElementById('nameInput');
    const signupEmailInput = document.getElementById('signupEmailInput');
    const signupPasswordInput = document.getElementById('signupPasswordInput');
    const userNameEl = document.getElementById('userName');
    const userAvatarEl = document.getElementById('userAvatar');
    const chatsListEl = document.getElementById('chatsList');
    const chatHeaderNameEl = document.getElementById('chatHeaderName');
    const chatAvatarEl = document.getElementById('chatAvatar');
    const chatStatusText = document.getElementById('chatStatusText');

    // State
    let isLoginForm = true;
    let currentUser = null;
    let currentChat = { id: 'default', title: 'Emma Stone' }; // demo chat
    let realtimeChannel = null;
    let demoMode = false;

    // Toggle between login and signup forms
    toggleFormLink.addEventListener('click', () => {
      isLoginForm = !isLoginForm;
      if (isLoginForm) {
        loginForm.classList.remove('hidden');
        signupForm.classList.add('hidden');
        toggleFormLink.textContent = 'Create new account';
      } else {
        loginForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        toggleFormLink.textContent = 'Sign in to existing account';
      }
    });

    // Dark Mode Toggle
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const icon = darkModeToggle.querySelector('i');
      if (document.body.classList.contains('dark-mode')) icon.className = 'fas fa-sun';
      else icon.className = 'fas fa-moon';
    });

    // ---------- Auth: Login ----------
    loginBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) { alert('Please enter both email and password'); return; }

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) { alert('Login failed: ' + error.message); return; }
        currentUser = data.user;
        authContainer.classList.add('hidden');
        await loadUserData();
        await setupRealtime();
      } catch (err) {
        console.error('Login error', err);
        startInDemoMode('Login request failed — running demo UI.');
      }
    });

    // ---------- Auth: Signup ----------
    signupBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim();
      const email = signupEmailInput.value.trim();
      const password = signupPasswordInput.value.trim();
      if (!name || !email || !password) { alert('Please fill all fields'); return; }

      try {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) { alert('Signup failed: ' + error.message); return; }
        // note: email confirmation might be required depending on your Supabase settings
        currentUser = data.user;
        // create or upsert profile
        const profile = {
          id: currentUser.id,
          full_name: name,
          created_at: new Date().toISOString()
        };
        const { error: profileError } = await supabase.from('profiles').upsert(profile, { returning: 'minimal' });
        if (profileError) console.warn('Profile creation warning:', profileError.message);

        authContainer.classList.add('hidden');
        await loadUserData();
        await setupRealtime();
      } catch (err) {
        console.error('Signup error', err);
        startInDemoMode('Signup request failed — running demo UI.');
      }
    });

    // ---------- OAuth buttons (redirect-based) ----------
    document.getElementById('googleBtn').addEventListener('click', async () => {
      try {
        const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
        if (error) alert('OAuth error: ' + error.message);
      } catch (err) {
        console.error(err);
      }
    });
    document.getElementById('facebookBtn').addEventListener('click', async () => {
      try {
        const { error } = await supabase.auth.signInWithOAuth({ provider: 'facebook' });
        if (error) alert('OAuth error: ' + error.message);
      } catch (err) {
        console.error(err);
      }
    });

    // ---------- Load user data / profile ----------
    async function loadUserData() {
      if (!currentUser) return;
      try {
        // fetch profile by id
        const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        if (error && error.code !== 'PGRST116') {
          // PGRST116: no rows (depends on PG REST error), but we will handle missing profile below
          console.warn('Profile fetch error', error);
        }
        if (data) {
          userNameEl.textContent = data.full_name;
          userAvatarEl.textContent = initialsFromName(data.full_name);
        } else {
          // fallback: create minimal profile using email if profiles table exists
          const fallbackName = currentUser.email ? currentUser.email.split('@')[0] : 'User';
          userNameEl.textContent = fallbackName;
          userAvatarEl.textContent = initialsFromName(fallbackName);
          // attempt create (safe upsert)
          try {
            await supabase.from('profiles').upsert({
              id: currentUser.id,
              full_name: fallbackName,
              created_at: new Date().toISOString()
            }, { returning: 'minimal' });
          } catch (err) {
            // ignore - maybe table doesn't exist
            console.warn('Could not upsert profile:', err);
          }
        }

        // populate the sidebar chats (demo placeholder)
        renderDemoChats();
      } catch (err) {
        console.error('loadUserData error', err);
        startInDemoMode('Loading user data failed — demo mode.');
      }
    }

    // helpers
    function initialsFromName(name) {
      if (!name) return 'U';
      return name.split(' ').map(part => part[0]?.toUpperCase() ?? '').slice(0,2).join('');
    }

    function renderDemoChats() {
      chatsListEl.innerHTML = `
        <div class="chat-item active" data-chat="default">
          <div class="chat-avatar">
            <div class="chat-avatar-img">ES</div>
            <div class="online-status"></div>
          </div>
          <div class="chat-info">
            <div class="chat-info-top">
              <div class="chat-name">Emma Stone</div>
              <div class="chat-time">10:42 AM</div>
            </div>
            <div class="chat-preview"><span>Are we still meeting tomorrow?</span><div class="unread-badge">3</div></div>
          </div>
        </div>
        <div class="chat-item" data-chat="robert">
          <div class="chat-avatar"><div class="chat-avatar-img">RD</div></div>
          <div class="chat-info">
            <div class="chat-info-top"><div class="chat-name">Robert Downey</div><div class="chat-time">Yesterday</div></div>
            <div class="chat-preview">Thanks for the recommendation!</div>
          </div>
        </div>
        <div class="chat-item" data-chat="startup">
          <div class="chat-avatar"><div class="chat-avatar-img">SG</div><div class="online-status"></div></div>
          <div class="chat-info">
            <div class="chat-info-top"><div class="chat-name">Startup Group</div><div class="chat-time">9:15 AM</div></div>
            <div class="chat-preview"><span>Alex:</span> Meeting moved to 2 PM</div>
          </div>
        </div>
      `;
      // attach click handlers to chat items to switch chat
      chatsListEl.querySelectorAll('.chat-item').forEach(el => {
        el.addEventListener('click', () => {
          chatsListEl.querySelectorAll('.chat-item').forEach(i=>i.classList.remove('active'));
          el.classList.add('active');
          const chatId = el.dataset.chat;
          openChat(chatId);
        });
      });
      // set initial chat
      openChat(currentChat?.id || 'default');
    }

    function openChat(chatId) {
      currentChat = { id: chatId, title: {
        default: 'Emma Stone',
        robert: 'Robert Downey',
        startup: 'Startup Group'
      }[chatId] || 'Conversation' };
      chatHeaderNameEl.textContent = currentChat.title;
      chatAvatarEl.textContent = currentChat.title.split(' ').map(n => n[0]).join('').slice(0,2);
      chatStatusText.textContent = (chatId === 'default' ? 'Online' : 'Last seen today');
      // load messages from DB (if table exists) or show demo messages
      loadMessagesForChat(chatId);
    }

    // ---------- Messages: load from DB or show demo ----------
    async function loadMessagesForChat(chatId) {
      messagesContainer.innerHTML = '';
      try {
        // attempt to fetch last 50 messages for chat from 'messages' table
        const { data, error } = await supabase
          .from('messages')
          .select('*')
          .eq('chat_id', chatId)
          .order('created_at', { ascending: true })
          .limit(100);

        if (error) {
          console.warn('Could not fetch messages (table might not exist):', error.message);
          populateDemoMessages();
          return;
        }
        if (!data || !data.length) {
          populateDemoMessages();
          return;
        }
        // render DB messages
        data.forEach(msg => {
          const isSent = !!(currentUser && msg.sender_id === currentUser.id);
          addMessageToUI(msg.content, isSent, msg.created_at);
        });
      } catch (err) {
        console.error('loadMessages error', err);
        populateDemoMessages();
      }
    }

    function populateDemoMessages() {
      addMessageToUI("Hey John! How's it going?", false, null);
      addMessageToUI('Pretty good! Just finished the project we were working on.', true, null);
      addMessageToUI("That's great to hear! Are we still meeting tomorrow to discuss the next steps?", false, null);
      addMessageToUI('Absolutely! 11 AM still works for me. Should I prepare anything?', true, null);
      addMessageToUI('If you could bring the analytics report, that would be perfect!', false, null);
    }

    // ---------- Realtime ----------
    async function setupRealtime() {
      // unsubscribe previous channel (if exists)
      try {
        if (realtimeChannel) {
          await supabase.removeChannel(realtimeChannel);
          realtimeChannel = null;
        }
      } catch (err) {
        console.warn('Error removing previous channel', err);
      }

      // If we don't have a messages table or the DB request fails, we still want the UI to work
      try {
        realtimeChannel = supabase.channel('public:messages')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
            // payload.new contains the inserted row
            if (!payload?.new) return;
            const isSent = currentUser && payload.new.sender_id === currentUser.id;
            // Only push messages for the active chat or if chat_id is null
            if (!currentChat || payload.new.chat_id === currentChat.id) {
              addMessageToUI(payload.new.content, isSent, payload.new.created_at);
            }
          })
          .subscribe((status) => {
            // status can be 'SUBSCRIBED' etc.
            // console.log('realtime status', status);
          });
      } catch (err) {
        console.warn('Realtime setup failed, continuing in demo mode.', err);
      }
    }

    // ---------- Send message ----------
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    async function sendMessage() {
      const content = messageInput.value.trim();
      if (!content) return;
      // Add to UI immediately
      const nowIso = new Date().toISOString();
      addMessageToUI(content, true, nowIso);
      messageInput.value = '';

      // Try to save to DB (if available)
      if (!currentUser) {
        // If no user (demo), simulate reply
        simulateReply();
        return;
      }
      try {
        const payload = {
          content,
          sender_id: currentUser.id,
          chat_id: currentChat?.id ?? null,
          created_at: nowIso
        };
        const { data, error } = await supabase.from('messages').insert([payload]).select().single();
        if (error) {
          console.warn('Failed to persist message (table may not exist):', error.message);
          // still simulate reply so you can test UX
          simulateReply();
          return;
        }
        // success — if realtime works, the subscription would also show this row. No further action needed.
      } catch (err) {
        console.error('sendMessage error', err);
        simulateReply();
      }
    }

    function simulateReply() {
      setTimeout(() => {
        const replies = [
          "Thanks for your message!",
          "I'll get back to you soon.",
          "That's interesting, tell me more!",
          "I agree with you on that point.",
          "Let's discuss this further tomorrow."
        ];
        const randomReply = replies[Math.floor(Math.random() * replies.length)];
        addMessageToUI(randomReply, false, new Date().toISOString());
      }, 800 + Math.random() * 700);
    }

    // ---------- UI: add message ----------
    function addMessageToUI(text, isSent, isoTime) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
      const timeText = isoTime ? (new Date(isoTime)).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : getCurrentTime();
      messageElement.innerHTML = `
        ${escapeHtml(text)}
        <div class="message-time">${timeText}</div>
      `;
      messagesContainer.appendChild(messageElement);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Very small HTML escape helper for text safety in UI
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // ---------- App init ----------
    async function initApp() {
      // try get current user
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) {
          console.warn('getUser error', error);
        }
        if (user) {
          currentUser = user;
          authContainer.classList.add('hidden');
          await loadUserData();
          await setupRealtime();
          return;
        }
        // no logged in user -> keep auth visible for login/signup
      } catch (err) {
        console.warn('Supabase init error — running demo mode.', err);
        startInDemoMode('Could not contact Supabase — demo mode activated.');
      }
    }

    // Start in demo fallback if something critical fails (non-blocking)
    function startInDemoMode(reason) {
      console.warn(reason);
      demoMode = true;
      // hide auth and show app UI as demo user
      authContainer.classList.add('hidden');
      currentUser = { id: 'demo_user', email: 'demo@local', full_name: 'Demo User' };
      userNameEl.textContent = currentUser.full_name;
      userAvatarEl.textContent = initialsFromName(currentUser.full_name);
      renderDemoChats();
      // not setting up realtime
    }

    // initialize UI and app
    initApp();

    // ---------- Utility: remove realtime channel helper for supabase v2 convenience ----------
    // supabase-js v2 exposes removeChannel on client; if not, just ignore
    if (!supabase.removeChannel) {
      supabase.removeChannel = async (channel) => {
        try { if (channel && channel.unsubscribe) await channel.unsubscribe(); } catch(e) {}
      };
    }

    // Done. Enjoy!
    // If you want, I can:
    //  - Wire conversations/chats to a 'conversations' table
    //  - Add message delivery/read receipts
    //  - Add file/image attachments upload (to Supabase Storage)
    // Ask which you'd like next! ✔️💡
  </script>
</body>
</html>
